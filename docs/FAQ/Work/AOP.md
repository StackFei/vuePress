---
title: AOP é¢å‘åˆ‡é¢ç¼–ç¨‹
date: 2019-11-03
tags:
- AOP
- JavaScript
---

## ä»€ä¹ˆæ˜¯AOP?
> ä»€ä¹ˆæ˜¯AOPï¼Ÿ å’ŒOOPåˆæœ‰ä½•å…³è”ï¼ŒAOPä¸­æ–‡æ„æ€æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¸OOPçš„é¢å‘å¯¹è±¡ç¼–ç¨‹ç›¸éš”ç”šè¿œã€‚å¬èµ·æ¥æ„Ÿè§‰å¾ˆæ¨¡ç³Šã€‚ä¸Šä¾‹å­ã€‚

- å†œåœºçš„æ°´æœåŒ…è£…æµæ°´çº¿ä¸€å¼€å§‹åªæœ‰ `é‡‡æ‘˜ - æ¸…æ´— - è´´æ ‡ç­¾`

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work9.png)

- ä¸ºäº†æé«˜é”€é‡ï¼Œæƒ³åŠ ä¸Šä¸¤é“å·¥åº `åˆ†ç±»` å’Œ `åŒ…è£…` ä½†åˆä¸èƒ½å¹²æ‰°åŸæœ‰çš„æµç¨‹ï¼ŒåŒæ—¶å¦‚æœæ²¡å¢åŠ æ”¶ç›Šå¯ä»¥éšæ—¶æ’¤é”€æ–°å¢å·¥åºã€‚

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work10.png)

- æœ€ååœ¨æµæ°´çº¿çš„ä¸­çš„ç©ºéš™æ’ä¸Šä¸¤ä¸ªå·¥äººå»å¤„ç†ï¼Œå½¢æˆ`é‡‡æ‘˜ - åˆ†ç±» - æ¸…æ´— - åŒ…è£… - è´´æ ‡ç­¾` çš„æ–°æµç¨‹ï¼Œè€Œä¸”å·¥äººå¯ä»¥éšæ—¶æ’¤å›ã€‚

å›å½’æ­£é¢˜ï¼Œä»€ä¹ˆæ˜¯AOP? ä¸‡ç‰©çš†ç¢ç‰‡ï¼Œå¯ä»¥éšæ„æ’å…¥ã€æ‹¼æ¥ã€åˆ é™¤ï¼Œç¼ºä¸å½±å“æ•´ä½“åŠŸèƒ½ï¼Œä¸OOPçš„ä¸‡ç‰©çš†å¯¹è±¡ç”šè‡³æœ‰ç‚¹è¿èƒŒã€‚ä¸è¿‡äºŒè€…æ˜¯å¯ä»¥ç›¸äº’èåˆä½¿ç”¨ï¼Œå–å…¶ç²¾åï¼Œå¼ƒå…¶ç³Ÿç²•ã€‚

## AOPå‰ä¸–ä»Šç”Ÿ
ç†è®ºçŸ¥è¯†è¿‡ä¸€éï¼Œå°±åˆ°äº†ç¼–ç æ—¶é—´ï¼Œå°†å…¶æ€æƒ³æ˜ å°„åˆ°ä»£ç ï¼Œ`AOP`çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼Œæœ€å¥½çš„ä¾‹å­å°±æ˜¯`é«˜é˜¶å‡½æ•°`çš„åº”ç”¨,æ˜ç¡®ä¸€ç‚¹ä½•ä¸ºé«˜é˜¶å‡½æ•°ï¼Ÿçœ‹ä¾‹å­ã€‚
- é«˜é˜¶å‡½æ•°
   - æŸä¸€ä¸ªå‡½æ•°ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°
   - æŸä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°
```javascript
function App(callback){
    callback()
}

function App(){
    return function App1(){
        // any wear
    }
}
```

## AOPåº”ç”¨åœºæ™¯
### AOPåº”ç”¨åœºæ™¯1-æ’å…¥åˆ‡ç‰‡
æ˜ç¡®ä¸€ç‚¹ï¼Œ`AOP`é¢å‘åˆ‡ç‰‡å°±æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­åœ¨æŸä¸€ä¸ªä½ç½®åˆ‡å¼€ä¸€ä¸ªå£æ’å…¥å¦å¤–ä¸€ä¸ªæ‰§è¡ŒåŠŸèƒ½ï¼Œæ¥ä¸‹æ¥ä¾‹ä¸¾ä¸€ä¸ªè¾ƒä¸ºå¸¸è§çš„ä¾‹å­ã€‚
```javascript
function Work(){
    console.log('ä¸æ‰“å¡ï¼Œä¸è®¡è€ƒå‹¤ï¼Œå¾ˆé«˜å…´ï¼Œæ‹¼å‘½æ•²ä»£ç  ğŸ˜')
}
```
åœ¨ä»¥å¾€æ²¡æœ‰è®°å½•è€ƒå‹¤æ—¶ï¼Œå¤§å®¶éƒ½ä¸éœ€è¦æ‰“å¡ï¼Œçªç„¶é—´å…¬å¸éœ€è¦è®°å½•è€ƒå‹¤ï¼Œä¸Šç­ä¹‹å‰éœ€è¦æ‰“å¡ï¼Œä¸‹ç­ä¹‹å‰éœ€è¦æ‰“å¡ã€‚ 
```javascript
function Work(){
    // ä¸Šç­æ‰“å¡
    console.log('æ‰“å¡ï¼Œè®¡è€ƒå‹¤ï¼Œä¸é«˜å…´ï¼Œä¸åƒæ•²ä»£ç ï¼Œæ¯å¤©æ‘¸é±¼ ğŸ˜­')
    // ä¸‹ç­æ‰“å¡
}
```
è¯´ä¸€ä¸‹æ€è·¯ï¼Œéœ€è¦åœ¨ä¸Šç­ä¹‹å‰ã€ä¹‹ååˆ†åˆ«æ·»åŠ æ‰“å¡çš„æ–¹æ³•ã€‚æ¯”è¾ƒç®€å•å·æ‡’çš„åšæ³•ï¼Œå°±æ˜¯ç›´æ¥åœ¨`function`çš„åŸå‹é“¾ä¸Šæ‰©å±•ä¸¤ä¸ªæ–¹æ³•`before`,`after`ï¼Œç„¶åå°†å®ƒå¡è¿›å»ã€‚å…ˆåªæ·»åŠ ä¸€ä¸ª`before`åŠŸèƒ½å°å°é²œã€‚
```javascript
function Work(){
    console.log('æ‰“å¡ï¼Œè®¡è€ƒå‹¤ï¼Œä¸é«˜å…´ï¼Œä¸åƒæ•²ä»£ç ï¼Œæ¯å¤©æ‘¸é±¼ ğŸ˜­')
}

Function.prototype.before = function (beforeCallback) {
    const _this = this
    return function () {
        beforeCallback()
        _this()
    }
}

const newWork = Work.before(function(){
    console.log('ä¸Šç­å‰æ‰“å¡')
})
newWork();
```
è¿™åœºæ™¯ï¼Œå…¸å‹çš„`HOC`æ²¡é”™äº†ï¼Œæ—¢æœ‰å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œåˆæœ‰å‡½æ•°ä½œä¸ºè¿”å›å€¼ï¼Œä½†ä¸ä¼šç«‹é©¬æ‰§è¡Œè¯¥å‡½æ•°ã€‚è¿™é‡Œä¹Ÿæ¶‰åŠåˆ°jsåŸºç¡€ï¼Œåœ¨åŸå‹é“¾ä¸Šæ‰©å±•æ–¹æ³•ï¼ŒçœŸå®å¼€å‘å¯åˆ«è¿™ä¹ˆåšï¼Œè¿˜æ˜¯åœ¨ç‰¹å®šçš„å‡½æ•°ä¸Šæ‰©å±•ï¼Œé¿å…æ±¡æŸ“å…¨å±€ã€‚éœ€è¦å€¼å¾—æ³¨æ„çš„æ˜¯`this`æŒ‡å‘çš„é—®é¢˜ï¼Œæ¶‰åŠåˆ°è¯æ³•ä½œç”¨åŸŸ`newWork()`æ‰§è¡Œæ—¶çš„ä¸Šä¸‹æ–‡æŒ‡å‘é—®é¢˜ï¼Œå°¤å…¶æ˜¯æµè§ˆå™¨`window`ä¸nodeçš„`global`ï¼Œä½¿å¾—å…¨å±€æŒ‡å‘ä¹Ÿè¾ƒä¸ºæ¨¡ç³Šï¼Œæ— æ³•åˆ¤æ–­ã€‚è¿™é‡Œä½¿ç”¨`_this`ä¿å­˜ä¸Šä¸‹æ–‡çš„æŒ‡å‘ï¼ŒåŸç†æ˜¯ä½œç”¨åŸŸå¾—ä»¥ä¿å­˜ï¼Œä½¿å¾—è¿™é‡Œçš„`this`å¾—ä»¥ä¿å­˜ï¼Œå†…éƒ¨èƒ½è®¿é—®å¤–éƒ¨çš„å˜é‡`this`ã€‚æˆ–è€…ä¹Ÿå¯ä»¥å°†å…¶æ¢ä¸º`() => {}` æ²¡æœ‰`arguments - this`ä¾¿å¯ä»¥ç›´æ¥`this()`è°ƒç”¨äº†ã€‚çœ‹æ•ˆæœå›¾ã€‚

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work11.png)

æ¥ä¸‹æ¥å°±å¯ä»¥å°è¯•åœ¨å°¾éƒ¨æ·»åŠ `after`åŠŸèƒ½ï¼Œå¤§ä½“å…¶å®ä¹Ÿæ²¡æœ‰åšå¤šå¤§æ”¹åŠ¨ã€‚çœ‹å®ä¾‹ä»£ç .
```javascript
function Work(){
    console.log('æ‰“å¡ï¼Œè®¡è€ƒå‹¤ï¼Œä¸é«˜å…´ï¼Œä¸åƒæ•²ä»£ç ï¼Œæ¯å¤©æ‘¸é±¼ ğŸ˜­')
}

Function.prototype.before = function (beforeCallback) {
    return () => {
        beforeCallback()
        // this()
    }
}

Function.prototype.after = function (beforeCallback,afterCallback) {
    return () => {
        beforeCallback()
        this()
        afterCallback()
    }
}

const newWork = Work.before(function(){
    console.log('ä¸Šç­å‰æ‰“å¡')
})
const newWork1 = Work.after(newWork,function(){
    console.log('ä¸‹ç­å‰æ‰“å¡')
})
newWork1();
```
çœ‹çš„å‡ºæ¥æ— éå°±æ˜¯åœ¨åŸå‹é“¾ä¸Šå¤šæ‰©å±•çš„æ–¹æ³•ã€‚å½“ç„¶è¿™åªæ˜¯ä¹ä¸ç‰ˆçš„ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘è¿‡å…¶ä»–æƒ…å†µï¼Œä¸€åˆ‡éƒ½åªæ˜¯ä»¥å¤åŸ`AOP`æ€è·¯ä¸ºä¸»ã€‚çœŸå®æƒ…å†µï¼Œå¯ä¸èƒ½è¿™æ ·ç¼–ç ,æ•ˆæœå›¾

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work12.png)

å½“ç„¶ï¼Œä¹Ÿæ˜¯æ”¯æŒä¼ å‚ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™å°†å‚æ•°æºå¸¦ä¼šåŸå‹é“¾ä¸Šçš„æ–¹æ³•ï¼Œèµ‹å€¼ç»™æ‰©å±•çš„å®ä¾‹æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ æ˜¯ä½¿ç”¨å‡½æ•°å¼çš„å†™æ³•æ˜¯å¯ä»¥ä½¿ç”¨`arguments` å¯ä»¥ç›´æ¥å°†å‚æ•°æ‹¿å‡ºï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯`() => {}` ï¼Œæ²¡æœ‰è¯¥å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`rest`è¿™ä¸ªAPIå°†å‚æ•°å»¶å±•å‡ºæ¥ã€‚è¿™é‡Œå°ç¼–å·æ‡’å°±æ˜¯ç”¨`...`æ‹¿å‚æ•°äº†ã€‚
```javascript
Function.prototype.before = function (beforeCallback) {
    return (...args) => {
        beforeCallback()
        this(...args)
    }
}
newWork1('å°ç¼–');
```
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä½¿ç”¨`_this`ä¿å­˜çš„`this`æŒ‡å‘ï¼Œæ˜¯å¦æ˜¯é—­åŒ…çš„åŸç† ï¼Ÿ

### AOPåº”ç”¨åœºæ™¯2-ä¿®æ”¹å±æ€§
é˜…è¯»è¿‡Vueæºç çš„éƒ½åº”è¯¥çŸ¥é“ï¼Œå…¶åŸç†ä¾¿æ˜¯åˆ©ç”¨`Object.defineProperty`æ¥åŠ«æŒæ•°æ®ä»¥æ›´æ–°è§†å›¾ï¼Œå½“ç„¶è¿™æ˜¯2.0ï¼Œ3.0æ˜¯ä½¿ç”¨`Proxy`æ¥ä»£ç†ã€‚åŠ«æŒæ•°æ®æˆ–è€…è¯´å•åªæŒ‡åŠ«æŒ`Array`å°±æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯`Array`çš„åŸå§‹APIæ“ä½œ`Array`æœ¬èº«ï¼Œæ˜¯æ— æ³•è¢«åŠ«æŒåˆ°æ˜¯å¦æ”¹å˜çš„ï¼Œæ‰€ä»¥Vueæºç ä¾¿å¯¹`Array`çš„åŸå§‹APIè¿›è¡Œé‡å†™ï¼Œå½“ç„¶ä¸æ˜¯å®Œå…¨é‡å†™ï¼Œè€Œæ˜¯å…ˆç»§æ‰¿ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥å»äº†è§£ä¸‹ã€‚å½“ç„¶è¿™ä¸åœ¨ä»Šå¤©çš„èŒƒç•´ä¹‹ç±»ã€‚è¿™ç§æ“ä½œï¼Œå°±å¯ä»¥ç†è§£ä¸ºæ˜¯`AOP`çš„æ€æƒ³æ“ä½œ
æ¥ä¸‹æ¥å°±åˆ—ä¸¾ä¸€ä¸ª`PUSH`çš„æ“ä½œæ¥ä¸¾ä¾‹è¯´æ˜ï¼Œæ˜ç¡®ç›®æ ‡ï¼Œæ¯æ¬¡è°ƒç”¨`PUSH`æ—¶ï¼Œæˆ‘éœ€è¦æ‰“å°å‡ºæˆ‘è°ƒç”¨è¿‡è¯¥æ–¹æ³•ã€‚åˆ†æä¸€ä¸‹å†™æ³•ï¼Œæ‹¿åˆ°åŸå‹é“¾ä¸Šçš„æ–¹æ³•ï¼Œåœ¨ç¼–å†™ä¸€ä¸ªè‡ªå·±çš„æ–¹æ³•ï¼Œåœ¨å°†`this`æŒ‡å‘åŸå‹é“¾ä¸Šçš„æ–¹æ³•ã€‚
```javascript
let oldPush = Array.prototype,push;

function myPush (...args) {
    console.log('Started execution ğŸ‘½')
    oldPush.call(this,...args)
}
const arr = ['ğŸš€','ğŸ›©']
myPush.call(arr, 'â›´')
console.log(arr)
```
è¿™é‡Œçš„`this`ç¨å¾®æœ‰ç‚¹ç»•ï¼Œéœ€è¦ç‰¢è®°çš„æ˜¯ï¼Œ`this`è¦æŒ‡å‘åŸå‹é“¾ä¸Šï¼Œç”±äº`myPush`ä¸Šæ²¡æœ‰`oldPush`,æ‰€ä»¥è°ƒç”¨è‡ªå·±å†™çš„`myPush`æ—¶éœ€è¦å°†æŒ‡å‘é€šè¿‡`call`å€¼å‘åˆ°åŸå§‹æ•°ç»„`oldPush`ä¸Šï¼Œå¹¶å°†åç»­çš„å‚æ•°ä¼ å…¥ã€‚å¹¶ä¸”åœ¨è‡ªå·±çš„`myPush`ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨è€çš„æ–¹æ³•ï¼Œè¿™æ ·`this`ä¼šé»˜è®¤æŒ‡å‘`window`,ä¹Ÿéœ€è¦é€šè¿‡ç›¸åŒçš„æ–¹æ³•ï¼Œè°ƒæ•´`this`æŒ‡å‘ã€‚æ‰€ä»¥æ— è®ºè°ƒç”¨å“ªä¸ªåœ°æ–¹çš„`call`ï¼Œ`this`æŒ‡å‘æ°¸è¿œä¸ä¼šæ··ä¹±æ°¸è¿œéƒ½æ˜¯æŒ‡å‘åŸå§‹æ•°ç»„ï¼Œçœ‹æ•ˆæœã€‚

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work13.png)

## AOPæ‰©å±•åœºæ™¯
æ—¢ç„¶`AOP`çš„åº”ç”¨åœºæ™¯å¦‚æ­¤å¹¿æ³›ï¼ŒVueä¸­ä½¿ç”¨ï¼ŒReactä¸­åŠ¿å¿…ä¹Ÿä¼šä½¿ç”¨ï¼Œæ¥ä¸‹é‡Œå°±åšä¸€ä¸ªå°çš„æ‰©å±•ï¼Œ`React v16.3`ä¹‹åæ–°å¢çš„`hooks`å±æ€§ä¸­çš„`useState`ä¾¿æ˜¯é‡‡ç”¨è¿™ç§åˆ‡ç‰‡æ–¹å¼æ¥å¤„ç†äº‹ä»¶ã€‚

![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work14.png)

æ‰§è¡Œæœºåˆ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼æ´‹è‘±æ¨¡å‹æœ‰ä¸æœ‰ï¼Œä»å¼€å§‹æ‰§è¡Œ`perform`åˆ°ç»“æŸ`maintained`ï¼Œä¸­é—´ä¼šæ‰§è¡Œä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯ä»¥æœ‰Nä¸ª`wrapper`æ¥åŒ…è£¹æ‰§è¡Œçš„æ–¹æ³•ï¼Œæœ‰`initialize`è¿‡åº¦åˆ°`close`ï¼Œç°å°†æ‰€æœ‰çš„è¯·æ±‚å¤´æ‰§è¡Œå®Œï¼Œåœ¨ä¾æ¬¡å°†è¯·æ±‚å¤´æ‰§è¡Œå…³é—­ã€‚æ˜ç¡®ä¸€ç‚¹ï¼Œ`perform`æ— ç–‘æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œæ¥å—å¤šä¸ª`wrapper`ã€ä»¥åŠä»»æ„`anyMethod`ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”è¿”å›å¤šä¸ªå¯æ‰§è¡Œé¡ºåºå‡½æ•°ã€‚å°†å…¶æ˜ å°„åˆ°ä»£ç æ¨¡å‹ä¸Šã€‚
```javascript
function perform(anyMethod, wrappers) {
    wrappers.forEach(wrapper => wrapper.initialize())
    anyMethod()
    wrappers.forEach(wrapper => wrapper.close())
}

perform(function () {
    console.log('ğŸš§')
}, [
    {
        initialize() {
            console.log('wrapper1  ğŸ‘±before')
        },
        close() {
            console.log('wrapper1  ğŸ‘©lose')
        },
    },
    {
        initialize() {
            console.log('wrapper2  ğŸ‘±before')
        },
        close() {
            console.log('wrapper2  ğŸ‘©close')
        },
    }
])
```
![workæ—¥å¸¸å·¥ä½œ](http://static.pengyunfei.top/image/Work/work15.png)

å½“ç„¶æƒ³å°†å…¶å˜ä¸ºé«˜é˜¶å‡½æ•°ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œä¹Ÿåªéœ€å°†æ‰§è¡Œçš„ç»“æœç”¨å‡½æ•°è¿”å›å³å¯ã€‚
```javascript
function perform(anyMethod, wrappers) {
    return function (){
        ...
    }
}
const perform(...)
```
å°±è¿™ä¹ˆç¨å¾®æ”¹ä¸€ä¸‹ï¼Œå°±åˆæœ‰äº†`AOP`çš„ç¼–ç¨‹è§„åˆ™ã€‚ç±»ä¼¼äºè¿™ä¸­`AOP` ç¼–ç¨‹æ€æƒ³çš„è¿˜æœ‰`axios`ä¸­çš„è¯·æ±‚åŠ«æŒï¼Œè¿™äº›éƒ½å¯ä»¥ç»†ç»†ç ”ç©¶ã€‚